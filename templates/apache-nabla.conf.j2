{# Set up VirtualHosts - servername and documentroot are required. This file was generated by ansible for {{ansible_fqdn}}. #}
{% for vhost in apache_vhosts_nabla %}
<IfModule mod_ssl.c>
		<VirtualHost _default_:443>
		#<VirtualHost 127.0.0.1:7074>
				# The ServerName directive sets the request scheme, hostname and port that
				# the server uses to identify itself. This is used when creating
				# redirection URLs. In the context of virtual hosts, the ServerName
				# specifies what hostname must appear in the request's Host: header to
				# match this virtual host. For the default virtual host (this file) this
				# value is not decisive as it is used as a last resort host regardless.
				# However, you must set it for any further virtual host explicitly.
				ServerName {{ vhost.servername }}
			  {% if vhost.serveradmin is defined %}
				ServerAdmin {{ vhost.serveradmin }}
			  {% endif %}
			  {% if vhost.serveralias is defined %}
				ServerAlias {{ vhost.serveralias }}
			  {% endif %}
			    RemoteIPHeader CF-Connecting-IP

				DocumentRoot {{ vhost.documentroot }}

				<Directory {{ vhost.documentroot }}>
						Options +Indexes -FollowSymLinks -MultiViews
						AllowOverride None
						Order allow,deny
						Allow from all
				</Directory>

				#ScriptAlias /cgi-bin/ /usr/lib/cgi-bin/
				#<Directory "/usr/lib/cgi-bin">
				#       AllowOverride None
				#       Options +ExecCGI -MultiViews +SymLinksIfOwnerMatch
				#       Order allow,deny
				#       Allow from all
				#</Directory>


				AddDefaultCharset utf-8

				LogFormat "{ \"version\": \"1.1\", \"host\": \"%V\", \"short_message\": \"%r\", \"timestamp\": %{%s}t, \"level\": 6, \"_user_agent\": \"%{User-Agent}i\", \"_source_ip\": \"%{jm-client-ip}i\", \"_duration_usec\": %D, \"_duration_sec\": %T, \"_request_size_byte\": %O, \"_http_status_orig\": %s, \"_http_status\": %>s, \"_http_request_path\": \"%U\", \"_http_request\": \"%U%q\", \"_http_method\": \"%m\", \"_http_referer\": \"%{Referer}i\", \"_from_apache\": \"true\" }" graylog_access

				LogFormat "{ \"timestamp\": \"%t\", \"service_name\": \"front\", \"trace_id\": \"%{X-Trace-ID}i\", \"level\": \"INFO\", \"client_ip\": \"%a\", \"jm_client_ip\": \"%{jm-client-ip}i\", \"http_endpoint\": \"%U\", \"http_request\": \"%U%q\", \"http_method\": \"%m\", \"http_referer\": \"%{Referer}i\", \"user_agent\": \"%{User-Agent}i\", \"duration\": %{ms}T, \"http_status_orig\": %s, \"http_status\": %>s, \"request_size_byte\": %O }" nabla_stdout

				ErrorLogFormat "{ \"timestamp\": \"%{%Y-%m-%d %T}t.%{usec_frac}t\", \"service_name\": \"front\", \"trace_id\": \"%{X-Trace-ID}i\", \"level\": \"%l\", \"pid\": %P, \"apr_os_error_state\": \"%E\", \"src_file\": \"%F\", \"client_ip\": \"%a\", \"jm_client_ip\": \"%{jm-client-ip}i\", \"message\": \"%M\" }"

                LogFormat "%a %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\"" combined

				ServerSignature Off
				ServerTokens Prod

				# Available loglevels: trace8, ..., trace1, debug, info, notice, warn,
				# error, crit, alert, emerg.
				# It is also possible to configure the loglevel for particular
				# modules, e.g.
				#LogLevel info ssl:warn
				LogLevel warn

				ErrorLog {{ apache_log_path }}/nabla_error.log
				CustomLog {{ apache_log_path }}/nabla_access.log combined

				# For most configuration files from conf-available/, which are
				# enabled or disabled at a global level, it is possible to
				# include a line for only one particular virtual host. For example the
				# following line enables the CGI configuration for this host only
				# after it has been globally disabled with "a2disconf".
				#Include conf-available/serve-cgi-bin.conf

				#ProxyPass / http://localhost:7070/
				#ProxyPassReverse / http://localhost:7070/
				#ProxyPreserveHost On
				#ProxyRequests off
		</VirtualHost>
</IfModule>

{% endfor %}

<IfModule mod_headers.c>

    Header unset ETag
    Header set X-Frame-Options: deny
    Header set X-XSS-Protection: "1; mode=block"
    Header set X-Content-Type-Options: nosniff
    Header set X-WebKit-CSP: "default-src 'self'"
    Header set X-Permitted-Cross-Domain-Policies: "master-only"
    Header always unset Date
    Header always unset Connection
    Header always unset Keep-Alive
    Header always unset Server
    Header always unset X-Powered-By
    Header always set ProcessingTime "%D"
#    Header always set Server albandri

    #Header set Content-Security-Policy "script-src 'self'; object-src 'self'"

    # `mod_headers` cannot match based on the content-type, however,
    # the `Content-Security-Policy` response header should be send
    # only for HTML documents and not for the other resources.

    #<FilesMatch "\.(%FilesMatchPattern%)$">
    #    Header unset Content-Security-Policy
    #</FilesMatch>

    Header set Content-Security-Policy-Report-Only "script-src 'self'; object-src 'self'"

</IfModule>

<IfModule security2_module>
    SecRuleEngine on
    ServerTokens Full
    SecServerSignature "Microsoft-IIS/6.0"
</IfModule>

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet
